<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <!--
      This Amos Professional Manual is written by asymetrix for the Amiga community and should stay completly FREE FOREVER.
      Created 2008. :)
  -->
  <title>Amos Professional Manual - Machine Code</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="keywords" content="Amos Professional, Amiga, Programming, Basic, Francois Lionet, Europress Software Ltd, Amos, computing, code, AmigaDOS">
  <meta name="author" content="asymetrix">

</head>

<body bgcolor="white">

<a href="../index.html">Amos Professional Manual</a>&nbsp; <a href="../contents/c1.html">Contents</a>&nbsp; <a href="../14/1446.html">Index</a>

<h1>Machine Code</h1>

<br>

<ul>
  <li>When the routine i's called from AMOS Professional Basic, certain registers will contain
      valuable information. Register <b>A3</b> will hold the parameter list. Register <b>A5</b> will contain the
      AMOS Professional data zone, which allows access to many internal functions directly from
      the machine code program.</li>
  <li>Although routines can alter any register, the <b>A7</b> stack should be left unchanged. Also note that
      registers <b>A3</b> to <b>A6</b> will not be returned in AREG functions.</li>
</ul>

<p><b>Creating a machine code language procedure</b><br>

Machine code procedures are installed using the [Inset Program] option from the
[Editor/Procedures] menu. The following steps should be followed:</p>

<ul>
  <li>Create a dummy procedure from the AMOS Professional Editor, like this:</li>
</ul>

<pre>
X> Procedure _MACHINE[A,A$]
   End Proc
</pre>

<p>
Existing closed procedures may also be used for this purpose, and it is perfectly legal to update a
routine after the machine code program has been re-assembled.</p>

<ul>
  <li>Position the text cursor inside the empty procedure.</li>
</ul>

<ul>
  <li>Select [Insert Program] from the menu. You will now be prompted with a standard AMOS</li>
      Professional file selector.</li>
</ul>

<ul>
  <li>Select the machine language program from the disc. It must be a normally assembled machine
      language which be run under CLI. A Workbench program or other commercial program
      cannot be inserted into a procedure. If this advice is ignored, your Amiga will crash when
      such a program is executed! The code must be PC relative, because AMOS Professional will
      ignore any relocation information in the file. The code must use a single segment only,
      because AMOS Professional will only load the first CODE segment into memory.</li>
</ul>

<ul>
  <li>AMOS Professional will now close the procedure and insert the selected machine language
      routine into memory. Any existing Basic instructions in the procedure will be removed!</li>
</ul>

<p>
Once the machine code is installed in this manner, it will be called automatically whenever the
new procedure is run from AMOS Professional Basic.</p>

<p><b>Communicating with a machine code procedure</b><br>

There are two methods of exchanging information with a machine code procedure.</p>

<p>
With the first method, values are loaded into the appropriate Address and Data registers, before
the procedure is called using the AREG and DREG functions. For example:</p>

<pre>
X> Dreg(0)=1 : Dreg(1)=Varptr(A$) : _MACHINE
   Procedure _MACHINE
</pre>

<div align="right"> <a href="1411.html">Back</a> &nbsp;&nbsp;
  <a href="1413.html">Next</a>
  <br>
  14.A.12
</div>

</BODY>
</HTML>
